<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.min.js"></script>
  <script src = "https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

  <style>

  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">

    div.type-buttons {
        /*position: fixed;*/
        position:relative;
        top: 50px;
        left: 100px;
        font-size: x-large;
        border: 5px;
        background-color: #9ec9ff;
      }

      div.metric-buttons {
        /*position: fixed;*/
        position:relative;
        top: 60px;
        left: 100px;
        font-size: x-large;
        padding: 5px;
        background-color: #9ec9ff;
      }

  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-1" id="button-container">
      </div>
      <div class="col-lg-11" id="svg-container">
      </div>
    </div>
  </div>
</body>
</html>
  <script type="text/javascript">

    var margin = 75,
        width = 1800 - margin,
        height = 900 - margin;

    var svg = d3.select("#svg-container")
        .append("svg")
        .attr("width", width + margin)
        .attr("height", height + margin)
        .append('g') // container element within svg
        .attr("class", "img-fluid");


    var projection = d3.geo.mercator()
                      .scale(260)
                      .translate([width/2, height / 1.8]);

    var path = d3.geo.path().projection(projection);

    // need these to persist for button selection
    var expiry = 7;
    var comparison = "costPerGB";



    queue()
    .defer(d3.json, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/world_countries.json")
    .defer(d3.csv, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/mobile-world-data.csv")
    .await(callback);



    // USE JAVA VARIABLE RULES THROUGHOUT!  var thisOtherThing = 10;


    function callback(error, worldData, mobileData) {


      // get list of country codes with country name (try and make this unique later?)
      var countries = mobileData.map(
        function(d) {return [d['country.code'], d['country.name']];}
        );

      // make object of country data by country code with name field and empty plan object to start...
      var countryData = {};
      countries.forEach(function(d) {
        countryData[d[0]] = {"name": d[1], "plan": {}};
      });


      // construct country data object
      mobileData.forEach(function(d) {

        // MOST COUNTRIES HAVE MORE THAN ONE ENTRY HERE WITH DIFFERENT EXPIRY
        d['cost.usd.bench.2gb.month'] = +d['cost.usd.bench.2gb.month'];
        d['cost.usd.per.gb'] = +d['cost.usd.per.gb'];
        d['expiry'] = +d['expiry'];
        d['gni.month'] = +d['gni.month'];
        d['percent.bench.income'] = +d['percent.bench.income'];

        //debugger;

        // CAREFUL WITH THE SYNTAX FOR CREATING ANOTHER OBJECT WITHIN THE COUNTRY DATA PLAN OBJECT (SAME AS PYTHON DICTIONARY)
        countryData[d['country.code']]['plan'][d.expiry] = {'costPerGB': d['cost.usd.per.gb'],
                                                    'avgMonthCost': d['cost.usd.bench.2gb.month'],
                                                    'avgMonthIncome': d['gni.month'],
                                                    'percentOfIncome': d['percent.bench.income']
                                                    };
        }); // mobileData iteration closure




      // bind mobile data in 'countryData' to world map data
      for(index in worldData.features){
        countryCode = worldData.features[index].id;

        if(countryCode in countryData){
          worldData.features[index]['mobile'] = {};

          for(plan in countryData[countryCode]['plan']){
            worldData.features[index]['mobile'][plan] = {};

            for(data in countryData[countryCode]['plan'][plan]){
              worldData.features[index]['mobile'][plan][data] = countryData[countryCode]['plan'][plan][data];
            }
          }
        }
      };



      // create map
      var map = svg.selectAll('path') // creating paths
                   .data(worldData.features) // data in '.features array'
                   .enter()
                   .append('path')
                   .attr('d', path)
                   .on("click", function(d) {
                    if(d.mobile != undefined){
                      for(plan in d.mobile){
                        for(data in d.mobile[plan]){
                          //debugger;
                          console.log("in " + d.properties.name + " a " + plan + " day plan cost " + d.mobile[plan][data] + " " + data);
                        }
                      }
                    }
                   }); // anon attr closure





      // apply choropleth
      function updateSelection(scheme) {

        duration = scheme[0];
        metric = scheme[1];



        // get values of interest across all countries for the particular duration and metric
        var targets = d3.selectAll("path")[0];
        var values = [];

        for(var index = 0; index < targets.length; index++){

          //debugger;
          var hasMobile = ('mobile' in targets[index].__data__)
          if(hasMobile){

            var plans = targets[index].__data__.mobile;
            var hasData = (duration in plans);

            //console.log(index + " " + hasData);
            if(hasData){

              values.push(plans[duration][metric]);
            }
          }
        }

        // get domain of values
        var domain = d3.extent(values);

        // color scale
        var color = d3.scale.quantize()
                    .domain(domain)
                    .range(["#e3e3e3", "#ffb464", "#fca141", "#fc9120", "#fe8300", "#de7302"]);

        //debugger;

        // fill in paths with color
        svg.selectAll('path')
                 .transition()
                 .duration(500)
                 .style('fill', function(d){

                  var hasMobile = ('mobile' in d)
                  if(hasMobile){
                    var hasData = (duration in d.mobile);
                    if(hasData){
                      //debugger;
                      return color(d.mobile[duration][metric]);
                    }
                  } else{return "gray"}
                 });


      } // updateSelection closure

      updateSelection([7, 'percentOfIncome']);



      // test updateselection
      /*updateSelection([1, 'costPerGB']);

      var delay=1500; //1.5 seconds
        setTimeout(function() {
          svg.selectAll('path')
                 .transition()
                 .duration(500)
                 .style('fill', updateSelection([7, 'percentOfIncome']));
          }, delay);*/





      // looking at the valid arguments for updateSelection we can see what data we want in the buttons
      types = [1, 7, 30]
      metrics = ['costPerGB', 'avgMonthCost', 'avgMonthIncome', 'percentOfIncome']
      var typeButtons = d3.select("#button-container")
                        .append("div")
                        .attr("class", "btn-group-vertical")
                        .attr("class", "type-buttons")
                        .selectAll("div")
                        .data(types)
                        .enter()
                        .append("div")
                        .text(function(d) {
                            return d;
                        });

      var metricButtons = d3.select("#button-container")
                        .append("div")
                        .attr("class", "btn-group-vertical")
                        .attr("class", "metric-buttons")
                        .selectAll("div")
                        .data(metrics)
                        .enter()
                        .append("div")
                        .text(function(d) {
                            return d;
                        });


      typeButtons.on("click", function(d) {
        debugger;
        //updateSelection([1, 'costPerGB'])

        });





    } // callback closure


  </script>
