<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="colorbrewer.min.js"></script>

  <style>

     h2 {
        text-align: center;
        color: black;
        font-size: 40px;
      }

    div.type-buttons {
        position: fixed;
        top: 550px;
        left: 100px;
        font-size: large;
      }

    div.type-buttons div {
      font-weight: bold;
      text-align: center;
      border-radius: 10px;
      background-color: LightGray;
      padding: 3px;
      margin: 7px;
    }

    div.metric-buttons {
      position: fixed;
      top: 700px;
      left: 100px;
      font-size: large;
    }

    div.metric-buttons div {
      font-weight: bold;
      text-align: center;
      border-radius: 10px;
      background-color: LightGray;
      padding: 3px;
      margin: 7px;
    }

    
    .country:hover {
        fill: #7acd6e;
      }
    


    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      border-radius: 2px;
    }

    /*oldskool tooltip

      div.tooltip {
      position: absolute;
      text-align: center;
      width: 150px;
      height: 25px;
      padding: 2px;
      font-size: 10px;
      background: #CEF6F5;
      border: 1px;
      border-radius: 8px;
      pointer-events: none;
      }*/


  </style>
</head>
<body>
</body>
</html>
  <script type="text/javascript">

    var description = d3.select("body").append("h2").text("Global Mobile Data Costs").attr("class", "description");

    var margin = 75,
        width = 1800 - margin,
        height = 900 - margin;

    var svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin)
        .attr("height", height + margin)
        .append('g'); // container element within svg

    var projection = d3.geo.mercator()
                      .scale(260)
                      .translate([width/2, height / 1.8]);

    var path = d3.geo.path().projection(projection);

    // these need to be global for button selection to persist
    var expiry;
    var comparison;

    // oldskool tooltip
    var tooltip = d3.select("body").append("div")
                  .attr("class", "tooltip")
                  .style("opacity", 0);

    // load data and callback
    queue()
    .defer(d3.json, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/world_countries.json")
    .defer(d3.csv, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/mobile-world-data.csv")
    .await(callback);



    function callback(error, worldData, mobileData) {

      // get list of country codes from mobile data (list is redundant, make unique later?)
      var countries = mobileData.map(
        function(d) {return d['country.code'];}
        );

      // make country data object by country codes, 
      // name field and empty plan object to start...
      var countryData = {};
      countries.forEach(function(d) {
        countryData[d] = {'plan': {}};
      });

      // construct country data object
      mobileData.forEach(function(d) {

        // MOST COUNTRIES HAVE MORE THAN ONE ENTRY HERE WITH DIFFERENT EXPIRY
        d['cost.usd.bench.2gb.month'] = +d['cost.usd.bench.2gb.month'];
        d['cost.usd.per.gb'] = +d['cost.usd.per.gb'];
        d['expiry'] = +d['expiry'];
        d['gni.month'] = +d['gni.month'];
        d['percent.bench.income'] = +d['percent.bench.income'];

        //debugger;

        // CAREFUL WITH THE SYNTAX FOR CREATING ANOTHER OBJECT WITHIN THE COUNTRY DATA PLAN OBJECT (SAME AS PYTHON DICTIONARY)
        countryData[d['country.code']]["gnipcmonthly"] = d['gni.month'];
        countryData[d['country.code']]['plan'][d.expiry] = {'Cost Per Gigabyte': d['cost.usd.per.gb'],
                                                    'Average Monthly Cost': d['cost.usd.bench.2gb.month'],
                                                    'Cost As Percent of Income (2GB/Month)': d['percent.bench.income']
                                                    };
        }); // mobileData iteration closure




      // bind mobile data in 'countryData' to world map data
      for(index in worldData.features){
        countryCode = worldData.features[index].id;

        if(countryCode in countryData){
          worldData.features[index]['mobile'] = {};
          worldData.features[index]['monthlyIncome'] = countryData[countryCode]["gnipcmonthly"];

          for(plan in countryData[countryCode]['plan']){
            worldData.features[index]['mobile'][plan] = countryData[countryCode]['plan'][plan];

            for(data in countryData[countryCode]['plan'][plan]){
              worldData.features[index]['mobile'][plan][data] = countryData[countryCode]['plan'][plan][data];
            }
          }
        }
      };

      tip = d3.tip().attr('class', 'd3-tip')
                    .html(function(d) {
                      //debugger;
                      var content = '<p>' + d.properties.name + '</p>';
                      if(d.monthlyIncome != undefined) {
                        content += '<p>Average Monthly Income: ' + d.monthlyIncome + '</p>';
                        for(plan in d.mobile){
                          for(data in d.mobile[plan]){
                            if(data == 'Cost Per Gigabyte') {
                              content += "<p>" + plan + "day " + data + ": " + d.mobile[plan][data] + "</p>";
                            }
                            if(data == 'Average Monthly Cost') {
                              content += "<p>" + plan + "day " + data + ": " + d.mobile[plan][data] + " (2GB)" + "</p>";
                            }
                            if(data == 'Cost As Percent of Income (2GB/Month)') {
                              content += "<p>" + plan + "day " + data + ": " + d.mobile[plan][data] + "</p>";
                            }
                          }
                        }
                      } else {
                        content += " (no data)";
                        }
                      return content;
                    });

      svg.call(tip);
      tip.direction('e');

      // create map
      var map = svg.selectAll('path') // creating paths
                   .data(worldData.features) // data in '.features array'
                   .enter()
                   .append('path')
                   .attr('d', path)
                   .attr("class", "country")

                   // oldskool tooltip functionality
                   /*.on("mouseover", function(d) {
                      d3.select(this).transition().duration(300).style("opacity", 0.7);
                      tooltip.transition().duration(300)
                       .style("opacity", 1)
                        tooltip.text(d.properties.name)
                       .style("left", (d3.event.pageX) + "px")
                       .style("top", (d3.event.pageY -30) + "px");
                    })
                    .on("mouseout", function() {
                    d3.select(this)
                    .transition().duration(300)
                    .style("opacity", 1);
                    tooltip.transition().duration(300)
                    .style("opacity", 0);
                    })*/

                   /*.on("click", function(d) {
                    if(d.mobile != undefined){
                      for(plan in d.mobile){
                        for(data in d.mobile[plan]){
                          //debugger;
                          console.log("in " + d.properties.name + " a " + plan + " day plan cost " + d.mobile[plan][data] + " " + data);
                        }
                      }
                    }
                   })*/ // anon attr closure
                   .on('mouseover', tip.show)
                   .on('mouseout', tip.hide);



      // apply choropleth
      function updateSelection(scheme) {

        duration = scheme[0];
        metric = scheme[1];


        // CREATE COLOR SCALE

        // first get values of interest across all countries for the particular duration and metric
        var targets = d3.selectAll("path")[0];
        var values = [];

        for(var index = 0; index < targets.length; index++){

          //debugger;
          var hasMobile = ('mobile' in targets[index].__data__)
          if(hasMobile){

            var plans = targets[index].__data__.mobile;
            var hasData = (duration in plans);

            //console.log(index + " " + hasData);
            if(hasData){

              values.push(plans[duration][metric]);
            }
          }
        }

        // get domain of values
        var domain = d3.extent(values);

        // color scale
        var color = d3.scale.quantile() //quantize()
                    .domain(domain)
                    .range(colorbrewer['OrRd']['9'].slice(2));

        //debugger;

        // fill in paths with color
        svg.selectAll('path')
                 .transition()
                 .duration(500)
                 .style('fill', function(d){
                  //debugger;
                  var hasMobile = ('mobile' in d);
                  if(hasMobile){
                    var hasData = (duration in d.mobile);
                    if(hasData){
                      //debugger;
                      return color(d.mobile[duration][metric]);
                    } else{return "LightGray"}
                  } else{return "LightGray"}
                 });


      } // updateSelection closure

      //updateSelection([30, 'Cost As Percent of Income (2GB/Month)']);



      // test updateselection
      /*var delay=1500; //1.5 seconds
      setTimeout(function(){updateSelection([1, 'Cost Per Gigabyte']);}, delay);
      setTimeout(function(){updateSelection([7, 'Cost Per Gigabyte']);}, delay);
      setTimeout(function(){updateSelection([30, 'Average Monthly Cost']);}, delay);
      setTimeout(function(){updateSelection([1, 'Average Monthly Cost']);}, delay);*/

      

      // looking at the valid arguments for updateSelection we can see what data we want in the buttons

      types = [[1, "Daily Expiry"], [7, "Weekly Expiry"], [30, "Monthly Expiry"]]
      // exclude 'Average Monthly Cost' since this won't change the choropleth any and 'Average Monthly Income' since no change over expiry
      metrics = ['Cost Per Gigabyte', 'Cost As Percent of Income (2GB/Month)']

      var typeButtons = d3.select("body")
                        .append("div")
                        .attr("class", "type-buttons")
                        .selectAll("div")
                        .data(types)
                        .enter()
                        .append("div")
                        .attr('data', function(d) {
                            return d[0];
                        })
                        .text(function(d) {
                            return d[1];
                        });

      var metricButtons = d3.select("body")
                        .append("div")
                        .attr("class", "metric-buttons")
                        .selectAll("div")
                        .data(metrics)
                        .enter()
                        .append("div")
                        .text(function(d) {
                            return d;
                        });






      typeButtons.on("click", function(d) {

        d3.select(".type-buttons")
                      .selectAll("div")
                      .transition()
                      .duration(500)
                      .style("background", "LightGray")
                      .style("color", "black");

        d3.select(this)
                      .transition()
                      .duration(500)
                      .style("background", "#a7f4cc")
                      .style("color", "white");

        expiry = d3.select(this).attr("data");
        //console.log(expiry);
        //console.log(comparison);
        updateSelection([expiry, comparison]);
        });





      metricButtons.on("click", function(d) {

        d3.select(".metric-buttons")
                      .selectAll("div")
                      .transition()
                      .duration(500)
                      .style("background", "LightGray")
                      .style("color", "black");

        d3.select(this)
                      .transition()
                      .duration(500)
                      .style("background", "#a7f4cc")
                      .style("color", "white");

        comparison = d3.select(this).text();
        //console.log(expiry);
        //console.log(comparison);
        updateSelection([expiry, comparison]);
        });





    } // callback closure


  </script>
