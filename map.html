<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://d3js.org/queue.v1.min.js"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <script src="colorbrewer.min.js"></script>

  <style>

    body {
      margin-left: 75px;
    }

     #map {
        margin-top: 50px;
      }

    div.buttons {
      position: absolute;
      top: 1000px;
      left: 150px;
      font-size: 18px;
    }

    div.buttons div {
      font-weight: bold;
      text-align: center;
      border-radius: 6px;
      background-color: LightGray;
      padding: 5px;
      margin: 15px;
    }

    .country:hover {
        stroke: yellow !important;
        stroke-width: 2px !important;
        transition-duration: 3s !important;
      }

    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(128, 0, 0, 0.5);
      color: #fff;
      border-radius: 8px;
    }

  </style>
</head>
<body>
  <h1>
  Mobile Broadband Cost Across The Globe
  </h1>
  <p>
  How do mobile data prices vary across the world?  How difficult is it for the average person in any given country to afford normal usage?  To answer these question I searched the internet for relevant data, ultimately combining information from 3 different datasets:
    <ul>
      <li> 
        <a href = https://docs.google.com/spreadsheets/d/1Z1rC3sg64jO9zzg7AuiUFHxaxdeRC1fLfAxwMRiImgg/edit?ts=5668e0e3#gid=0>2015 Mobile Broadband Prices - Google</a> (http://policybythenumbers.blogspot.com/)
      </li>
      <li>
        <a href = http://data.worldbank.org/indicator/NY.GNP.PCAP.PP.CD>GNI PPP - World Bank</a>
      </li>
      <li>
        <a href = http://www.xe.com/currencytables/?from=USD&date=2015-06-24>2015 Currency Exchange Rates - XE</a>
      </li>
    </ul>
    <h2>Summary
    </h2>This visualization is a choropleth map encompassing the globe.  There are buttons on the bottom left that enable you to color the choropleth either by average cost in U.S. dollars per gigabyte or relative cost of mobile usage as a percent of the average income for that country.  Mobile usage is assumed to be approximately 2GB per month based on anecdotal information from undocumented sources on the internet.
    <h2>Design
    </h2>I decided to keep this choropleth map as simple as possible.  After getting some feedback, I elected to keep data for monthly expiry only.  Originally, I had the option to facet the choropleth by expiry type with another button but this left the map incomplete for some expiry.  I also chose to leave out plans including voice/sms as there was not enough data.  Finally prepaid and postpaid plans were combined as the difference in price for similar expiry was negligible.  Factoring in all of this, the hue of the fill is based upon 1 of 7 discrete buckets for either comparative metric.
    <h2>Feedback
    </h2>Originally, I had the option to facet the choropleth by expiry type with another button. According to some feedback, this left the map feeling incomplete for some expiry. Also, because I had so much data, the tooltips for each country were too big for the map size and sometimes misplaced. Coloring was changed to represent buckets instead of numerical values which improved color distribution.
    <div id="map">
    </div>
    <h2>Resources
    </h2>
    <ul>
      <li>
        <a href = https://github.com/mbostock/d3/wiki/API-Reference>D3 API</a>
      </li>
      <li>
        <a href = http://labratrevenge.com/d3-tip/>D3-tip by Caged</a>
      </li>
      <li>
        <a href = http://www.jeromecukier.net/blog/2011/08/11/d3-scales-and-color/>Jerome Cukier's Articles</a>
      </li>
      <li>
        <a href = https://www.udacity.com/courses/ud507/>Udacity's Data Visualization and D3.js course</a>
      </li>
    </ul>
  </p>
</body>
</html>
  <script type="text/javascript">

    var margin = 75;
        width = 1800 - margin,
        height = 800 - margin;

    var svg = d3.select("#map")
        .append("svg")
        .attr("width", width + margin)
        .attr("height", height + margin)
        .append('g'); // container element within svg
        

    var projection = d3.geo.mercator()
                      .scale(260)
                      .translate([width/2, height/1.7]);

    var path = d3.geo.path().projection(projection);

    // update selection argument variables need to be global for MULTIPLE button selection
    var comparison;

    // load data and callback
    queue()
    .defer(d3.json, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/world_countries.json")
    .defer(d3.csv, "https://raw.githubusercontent.com/winkelman/udacity-dand-viz-project/master/mobile-world-data.csv")
    .await(callback);



    function callback(error, worldData, mobileData) {

      // get list of country codes from mobile data (list is redundant, make unique later?)
      var countries = mobileData.map(
        function(d) {return d['country.code'];}
        );

      // make country data object by country codes, 
      // empty cost per gb and cost as percent gni...
      var countryData = {};
      countries.forEach(function(d) {
        countryData[d] = {'costusdgb': '', "gnimonthly": '', "percentgni": '', 'costbucket': '', 'percentbucket': ''};
      });

      // construct country data object
      mobileData.forEach(function(d) {

        d['cost.usd.per.gb'] = +d['cost.usd.per.gb'];
        d['gni.month'] = +d['gni.month'];
        d['percent.income'] = +d['percent.income'];

        //debugger;

        countryData[d['country.code']]["costusdgb"] = d['cost.usd.per.gb'];
        countryData[d['country.code']]["gnimonthly"] = d['gni.month'];
        countryData[d['country.code']]["percentgni"] = d['percent.income'];
        countryData[d['country.code']]["costbucket"] = d['cost.usd.per.gb.bucket'];
        countryData[d['country.code']]["percentbucket"] = d['percent.income.bucket'];
        
        }); // mobileData iteration closure




      // bind mobile data in 'countryData' to world map data
      for(index in worldData.features){
        //debugger;
        countryCode = worldData.features[index].id;

        if(countryCode in countryData){
          worldData.features[index]['mobile'] = {};
          worldData.features[index]['monthlyIncome'] = countryData[countryCode]["gnimonthly"];
          worldData.features[index]['mobile']['costUSDGB'] = countryData[countryCode]["costusdgb"];
          worldData.features[index]['mobile']['costRelative'] = countryData[countryCode]["percentgni"];
          worldData.features[index]['mobile']['costBucket'] = countryData[countryCode]["costbucket"];
          worldData.features[index]['mobile']['relativeBucket'] = countryData[countryCode]["percentbucket"];
        }
      }; // worldData.features for loop closure


      tip = d3.tip().attr('class', 'd3-tip')
                    .html(function(d) {
                      var content = '<p>' + d.properties.name + '</p>';
                      //debugger;
                      if(d.mobile != undefined){
                        if(comparison == 'costUSDGB'){
                          content += '<p>$' + d.mobile[comparison] + ' (USD)</p>';
                        }
                        if(comparison == 'costRelative'){
                          
                          content += '<p>' + d.mobile[comparison] + '%</p>';
                          content += '<p>Monthly Income: $' + d.monthlyIncome + ' (USD)</p>';
                        }
                      } else {
                        content += " (no data)";
                        }
                      return content;
                    })
                    .offset(function() {
                      return [0,0];
                    });


      svg.call(tip);
      tip.direction('s');

      // create map
      var map = svg.selectAll('path') // creating paths
                   .data(worldData.features) // data in '.features array'
                   .enter()
                   .append('path')
                   .attr('d', path)
                   .style('fill', 'gray')
                   .attr("class", "country")
                   .on('mouseover', tip.show)
                   .on('mouseout', tip.hide);



      // apply choropleth
      function updateSelection(comparison) {


        // CREATE COLOR SCALE

        /*
        // NO NEED TO DO THIS NOW THAT WE HAVE BUCKETS
        // first get values of interest across all countries for the particular duration and metric
        var targets = d3.selectAll("path")[0];
        var values = [];

        for(var index = 0; index < targets.length; index++){

          //debugger;
          var hasMobile = ('mobile' in targets[index].__data__)
          if(hasMobile){
            //debugger;
            var data = targets[index].__data__.mobile[scheme];
            values.push(data);
          }
        }
        */

        // get domain of values and bucket variable for the comparison specified
        var domain;
        var scheme;
        if(comparison == 'costUSDGB') {
          domain = ['(0,2]', '(2,5]', '(5,10]', '(10,20]', '(20,30]', '(30,50]', '(50,Inf]'];
          scheme = 'costBucket';
        }
        if(comparison == 'costRelative') {
          domain = ['(0,1]', '(1,3]', '(3,5]', '(5,10]', '(10,20]', '(20,40]', '(40,Inf]'];
          scheme = 'relativeBucket';
        }

        // color scale
        var color = d3.scale.ordinal()
                    .domain(domain)
                    .range(colorbrewer['Blues']['9'].slice(2));


        // fill in paths with color
        svg.selectAll('path')
                 .transition()
                 .duration(800)
                 .style('fill', function(d){
                  //debugger;
                  var hasMobile = ('mobile' in d);
                  if(hasMobile){
                      return color(d.mobile[scheme]);
                    } else{return "DimGray"}
                 });


      } // updateSelection closure


      // for debugging...
      //comparison = 'costUSDGB';
      //updateSelection(comparison);

      

      // looking at the valid arguments for updateSelection we can see what data we want in the buttons
      
      var buttonData = [['Average Cost Per Gigabyte', 'costUSDGB'],
      ['Percent of Monthly Income (2GB)', 'costRelative']];

      var buttons = d3.select("body")
                        .append("div")
                        .attr("class", "buttons")
                        .selectAll("div")
                        .data(buttonData)
                        .enter()
                        .append("div")
                        .text(function(d) {
                            return d[0];
                        });


      buttons.on("click", function(d) {

        // reset all buttons first
        d3.select(".buttons")
                      .selectAll("div")
                      .transition()
                      .duration(600)
                      .style("background", "LightGray")
                      .style("color", "black");

        d3.select(this)
                      .transition()
                      .duration(600)
                      .style("background", 'Maroon')
                      .style("color", "white");
      
        comparison = d[1];
        //debugger;
        updateSelection(comparison);
        });





    } // callback closure


  </script>
